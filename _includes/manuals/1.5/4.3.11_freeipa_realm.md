The FreeIPA implementation of the realm proxy is able to add a host entry to FreeIPA, send the hostgroup label, and request a one-time registration password.

#### Configuration of FreeIPA

Your Smart Proxy should be registered to the FreeIPA realm already.  You'll also need to create a special role for the Smart Proxy
with the minimum sets of permissions.

From a machine with ipa-admintools:

 1. Obtain Kerberos Credentials

        kinit admin

 2. Create a new privilege 

        ipa privilege-add 'Smart Proxy Host Management' --desc='Smart Proxy Host Management'

 3. Create the permissions needed to update one-time passwords and the userclass:

        ipa permission-add 'modify host password' --permissions='write' --type='host' --attrs='userpassword'
        ipa permission-add 'modify host userclass' --permissions='write' --type='host' --attrs='userclass'

 4. Add the permissions to the privilege:

        ipa privilege-add-permission 'Smart Proxy Host Management' --permission='add hosts' --permission='remove hosts' --permission='modify host password' --permission='modify host userclass' --permission='modify hosts'

 5. Create a new role:

        ipa role-add 'Smart Proxy' --desc='Smart Proxy management'

 6. Assign the privilege to the role:

        ipa role-add-privilege 'Smart Proxy' --privilege='Smart Proxy Host Management' --privilege='Host Group Administrators'


 7. Create a user in FreeIPA for the proxy to use, such as `realm-proxy`.  Don't use foreman-proxy or foreman as the username! 

        ipa user-add realm-proxy

 8. Assign the above created role:

        ipa role-add-member 'Smart Proxy' --users=realm-proxy

On the Smart Proxy machine, which needs to be registered to FreeIPA:

 1. Fetch a keytab for your user and set appropriate permissions:

        kinit realm-proxy
        ipa-getkeytab -s <ipa server> -p realm-proxy@EXAMPLE.COM -k /usr/share/foreman-proxy/config/freeipa.keytab
        chown foreman-proxy /usr/share/foreman-proxy/config/freeipa.keytab
        chmod 600 /usr/share/foreman-proxy/config/freeipa.keytab

#### Configuration of smart-proxy

Enable the realm proxy in `config/settings.yaml`:

    :realm: true

Set the realm provider to freeipa:

    :realm_provider: freeipa

Provide the location of the keytab and the principal (user) you're using:

    :realm_keytab: /usr/share/foreman-proxy/config/freeipa.keytab
    :realm_principal: realm-proxy@EXAMPLE.COM

If you're using FreeIPA to manage DNS records, and want them to be 
automatically deleted when the host is deleted in Foreman, set this
to true:

    :freeipa_remove_dns: true

#### Using Automember Rules

FreeIPA supports the ability to setup automember rules based on attributes of a system.  When using the FreeIPA proxy, the Foreman host group is available as a parameter in FreeIPA known as `userclass`.

First, we create a host group in FreeIPA:

    # ipa hostgroup-add webservers
    Description: web servers
    ----------------------------
    Added hostgroup "webservers" 
    ----------------------------
      Host-group: webservers
      Description: web servers

Define an automember rule:

    # ipa automember-add --type=hostgroup webservers
    ----------------------------------
    Added automember rule "webservers" 
    ----------------------------------
    Automember Rule: webservers

Create an automember condition based on the `userclass` attribute:

    # ipa automember-add-condition --key=userclass --type=hostgroup --inclusive-regex=^webserver webservers
    ----------------------------------
    Added condition(s) to "webservers" 
    ----------------------------------
      Automember Rule: webservers
      Inclusive Regex: userclass=^webserver
    ----------------------------
    Number of conditions added 1
    ----------------------------

When a machine in Foreman is in the "webservers" host group, it will automatically be added to the FreeIPA
"webservers" host group as well.  FreeIPA host groups allow for Host-based access controls (HBAC), sudo policies,
etc.
