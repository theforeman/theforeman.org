
Activate the Puppet CA management module within the Smart Proxy instance.  This is used to manage the autosign configuration and handle listing, signing and revocation of individual certificates.

Builtin providers are:

* `puppetca_hostname_whitelisting` - direct management of Puppet's `autosign.conf`
* `puppetca_token_whitelisting` - manage token-based signing of certificate requests

This should only be enabled in the Smart Proxy that is hosted on the machine responsible for providing certificates to your puppet clients. On this host enable the feature in `puppetca.yml`:

```yaml
:enabled: https
```

Also choose the provider to use, default should be `puppetca_hostname_whitelisting`:
```yaml
:use_provider: puppetca_hostname_whitelisting
```

Lastly the Puppet version needs to be specified. Since version 6 the `puppetca_http_api` implementation is used while on earlier versions the `puppetca_puppet_cert` implementation is used.
```yaml
:puppet_version: '6.8.0'
```

#### puppetca_hostname_whitelisting

The `puppetca_hostname_whitelisting` provider directly manages Puppet's `autosign.conf` file.
This will create an autosign entry for a host during deployment and remove it when deployment is finished.
Furthermore it allows you to manage entries manually using the Foreman WebUI.

The **autosignfile** setting in `puppetca_hostname_whitelisting.yml` is used to find autosign.conf:

```yaml
:autosignfile: /etc/puppetlabs/puppet/autosign.conf
```

The location of the file can be determined with `puppet config print autosign`.

The proxy requires write access to the puppet autosign.conf file, which is usually owner and group puppet, and has mode 0644 according to the puppet defaults. Ensure the foreman-proxy user is added to the puppet group ( e.g. `gpasswd -a foreman-proxy puppet` or `usermod -aG puppet foreman-proxy`)

puppet.conf:
```ini
[master]
autosign = $confdir/autosign.conf {owner = service, group = service, mode = 664 }
```

#### puppetca_token_whitelisting

The `puppetca_token_whitelisting` provider uses a token-based certificate signing managed by the Smart Proxy itself and queried by Puppet during Provisioning.
This provider adds more security and logging to the autosigning process but does not allow for manual creation of autosigning entries.

This provider has the following settings in `puppetca_token_whitelisting.yml`:

```yaml
:sign_all: false
:token_ttl: 360
:tokens_file: /var/lib/foreman-proxy/tokens.yml
```

By changing **sign_all** to `true` you will disable token verification and sign all certificate requests.
The setting **token_ttl** defines how long a token after creation is valid in minutes.
**tokens_file** sets the path to the file used to store tokens during deployment, the foreman-proxy user requires read and write access to this file.

You can also change the certificate used for encrypting the token file by setting **certificate**. By default it uses the certificate of the Smart Proxy defined in `settings.yml` as **ssl_certificate**.

To integrate this in Puppet the script `puppet_sign.rb` provided by the Smart Proxy has to be used for verfication of the tokens during certificate signing.
If installed via package the script should be already located at `/usr/libexec/foreman-proxy/puppet_sign.rb`.
For manual installation the script can be found on [Github](https://github.com/theforeman/smart-proxy/blob/develop/extra/puppet_sign.rb). Using the latest version should be fine, if you encounter problems try the one released with your Smart Proxy version.
The script has to be executable by the same user running the Puppet server, typically puppet.

After deploying the script the Puppet configuration has to be changed to point the **autosign** setting to the script.

```ini
[master]
autosign = /usr/libexec/foreman-proxy/puppet_sign.rb
```

#### puppetca_puppet_cert

**Note** this is used in Puppet 5 and earlier as determined by the `puppet_version` setting in `puppetca.yml`.

This implementation is used for managing certificates. It uses the `puppet cert` command and typically requires sudo access for the proxy.

```yaml
:ssldir: /etc/puppetlabs/puppet/ssl
#:puppetca_use_sudo: false
#:sudo_command: /usr/bin/sudo
```

The `ssldir` setting is required and can be determined with `puppet config print ssldir`. Puppet AIO defaults to using `/etc/puppetlabs/puppet/ssl`.

By default sudo is used but can be disabled with `puppetca_use_sudo` setting. The sudo command is dermined via the `PATH` variable or can be explicitly set with the `sudo_command` setting.

For sudo to work correctly, it must be configured to allow `puppet cert` with NOPASSWD and without requiretty. Under a Puppet AIO installation, configuration should be:

```
foreman-proxy ALL = NOPASSWD: /opt/puppetlabs/bin/puppet cert *
Defaults:foreman-proxy !requiretty
```

Under a non-AIO Puppet installation:

```
foreman-proxy ALL = NOPASSWD: /usr/bin/puppet cert *
Defaults:foreman-proxy !requiretty
```

#### puppetca_http_api

**Note** this is used in Puppet 6 and newer as determined by the `puppet_version` setting in `puppetca.yml`.

As the name implies, Puppetserver's HTTP API is used to manage certificates. In its configuration file `puppetca_http_api.yml` the connection details are configured:

```yaml
:puppet_url: https://puppet.example.com:8140
:puppet_ssl_ca: /etc/puppetlabs/ssl/certs/ca.pem
:puppet_ssl_cert: /etc/puppetlabs/ssl/certs/puppet.example.com.pem
:puppet_ssl_key: /etc/puppetlabs/ssl/private_keys/puppet.example.com.pem
```

The Puppet server does not need to be on the same host, but only the `puppetca_token_whitelisting` provider supports this. Note the Puppetserver also needs to allow access to the Smart Proxy.
